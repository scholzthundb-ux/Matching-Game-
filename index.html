<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vokabel-Matching</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#f2e6d5;
      --text:#111;
      --muted:#666;
      --border:#ddd;
      --shadow: 0 2px 10px rgba(0,0,0,.06);
      --ok:#1f7a1f;
      --bad:#b42318;
      --accent:#0b57d0;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--text);
    }
    .app{min-height:100vh;display:flex;flex-direction:column;}
    header{
      padding:14px 16px;border-bottom:1px solid var(--border);
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      position:sticky;top:0;background:var(--bg);z-index:10;
    }
    header h1{font-size:16px;margin:0;font-weight:900;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .mini{font-size:12px;color:var(--muted);font-weight:900;}
    button{
      border:1px solid var(--border);
      background:#fff;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer;
    }
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
    button.danger{border-color:#f1b4b0;background:#fff;color:var(--bad);}
    button:disabled{opacity:.5;cursor:not-allowed;}
    select{
      border:1px solid var(--border);
      background:#fff;border-radius:10px;padding:10px 12px;font-weight:800;
    }
    input[type="checkbox"]{transform:scale(1.05);}
    .wrap{padding:16px;max-width:1200px;width:100%;margin:0 auto;}
    .panel{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      background:#fff;
    }
    textarea,input{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:170px;resize:vertical;}
    .muted{color:var(--muted);font-size:13px;line-height:1.35;}
    .pill{
      display:inline-block;padding:4px 8px;border-radius:999px;
      background:#f6f6f6;border:1px solid var(--border);
      font-size:12px;color:var(--muted);font-weight:900;
    }
    .grid2{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;}
    @media (max-width:900px){.grid2{grid-template-columns:1fr;}}

    /* Preview + tables */
    .listTable{width:100%;border-collapse:collapse;font-size:14px;}
    .listTable th,.listTable td{border-bottom:1px solid var(--border);padding:10px 8px;vertical-align:top;}
    .listTable th{text-align:left;font-size:13px;color:var(--muted);font-weight:1000;}
    .starsBtn{
      border:1px solid var(--border);
      background:#fff;border-radius:10px;padding:8px 10px;
      font-weight:1000;cursor:pointer;min-width:70px;text-align:center;
    }
    .previewBox{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:auto;
      max-height:360px;
    }
    .previewHeader{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      background:#fff;position:sticky;top:0;z-index:2;
    }
    .hint{font-size:12px;color:var(--muted);font-weight:900;}

    /* Game */
    .game{flex:1;display:none;padding:10px;}
    .gameTop{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:10px 6px;flex-wrap:wrap;
    }
    .stats{font-size:14px;color:var(--muted);font-weight:900;}
    .msg{font-size:14px;font-weight:1000;min-height:18px;}
    .msg.ok{color:var(--ok);} .msg.bad{color:var(--bad);}
    .board{
      flex:1;display:grid;grid-template-columns:1fr 1fr;gap:12px;
      height: calc(100vh - 175px); padding:6px;
    }
    @media (max-width:700px){.board{gap:10px;height: calc(100vh - 215px);}}
    .col{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
      background:#fff;
      box-shadow:var(--shadow);
      overflow:auto;
    }
    .colTitle{font-weight:1000;margin:0 0 10px 0;font-size:14px;}
    .cards{display:flex;flex-direction:column;gap:10px;}
    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:12px 12px;
      box-shadow:0 1px 6px rgba(0,0,0,.05);
      cursor:pointer;user-select:none;
      transition:transform .05s ease, outline-color .1s ease;
      outline:3px solid transparent;
    }
    .card:active{transform:scale(.99);}
    .card.selected{outline-color:var(--accent);}
    .card.correctFlash{outline-color:var(--ok);}
    .card.wrongFlash{outline-color:var(--bad);}
    .leftText{font-weight:1000;}
    .starLine{margin-top:5px;font-size:12px;color:var(--muted);font-weight:900;}
    .footerBar{
      display:flex;gap:10px;justify-content:flex-end;
      padding:10px 6px 14px 6px;flex-wrap:wrap;
    }
  </style>
</head>
<body>
<div class="app">

  <header>
    <h1>Vokabel-Matching</h1>
    <div class="row">
      <button id="btnShowEditor">Eingabe / Liste</button>
      <button class="primary" id="btnStart">Üben starten</button>
      <button id="btnFullscreen">Vollbild</button>
    </div>
  </header>

  <!-- EDITOR -->
  <div class="wrap" id="editorScreen">
    <div class="grid2">

      <div class="panel">
        <h2 style="margin:0 0 10px 0; font-size:16px;">Vokabelliste eingeben + Favoriten</h2>

        <p class="muted" style="margin-top:0;">
          Pro Zeile: <span class="pill">Vokabel = Übersetzung</span><br>
          Sterne pro Zeile möglich: <span class="pill">*</span> / <span class="pill">**</span> / <span class="pill">***</span> oder <span class="pill">[1]</span> / <span class="pill">[2]</span> / <span class="pill">[3]</span><br>
          Zusätzlich kannst du eine <b>ganze Liste</b> mit ★ / ★★ / ★★★ markieren (mit Option, vorhandene Zeilen-Sterne zu behalten).
        </p>

        <textarea id="bulkInput" placeholder="der Kreisel = la peonza ***&#10;Knoblauch anbraten = sofreír el ajo **&#10;die Wasserpumpe = la bomba de agua *"></textarea>

        <div class="row" style="margin-top:10px; align-items:center;">
          <span class="mini">Ganze Liste als Favorit:</span>
          <select id="bulkStar">
            <option value="0">—</option>
            <option value="1">★</option>
            <option value="2">★★</option>
            <option value="3">★★★</option>
          </select>

          <label class="row" style="gap:8px;">
            <input type="checkbox" id="keepLineStars" checked>
            <span class="mini">Zeilen mit Sternchen nicht überschreiben</span>
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnAnalyze">Liste analysieren (Vorschau)</button>
          <button class="primary" id="btnImport">Importieren / Aktualisieren</button>
          <button id="btnClear">Alles löschen</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnExport">Backup exportieren (TXT)</button>
          <input type="file" id="fileImport" accept=".txt,text/plain" style="display:none;">
          <button id="btnImportTxt">TXT laden</button>
        </div>

        <p class="muted" id="importInfo" style="margin:10px 0 0 0;"></p>

        <div class="previewBox" id="previewBox" style="display:none;">
          <div class="previewHeader">
            <div class="row">
              <span class="pill" id="previewCount">0 Zeilen</span>
              <span class="hint">Sterne anklicken: 0→1→2→3→0</span>
            </div>
            <div class="row">
              <span class="mini">Vorschau: alle setzen</span>
              <button id="setAll0">—</button>
              <button id="setAll1">★</button>
              <button id="setAll2">★★</button>
              <button id="setAll3">★★★</button>
            </div>
          </div>
          <table class="listTable" style="margin:0;">
            <thead>
              <tr><th>Vokabel</th><th>Übersetzung</th><th>Favorit</th></tr>
            </thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h2 style="margin:0 0 10px 0; font-size:16px;">Einzelnen Eintrag hinzufügen</h2>

        <div class="row" style="width:100%;">
          <div style="flex:1; min-width:220px;">
            <input id="oneLeft" placeholder="Vokabel (links)" />
          </div>
          <div style="flex:1; min-width:220px;">
            <input id="oneRight" placeholder="Übersetzung (rechts)" />
          </div>
        </div>

        <div class="row" style="margin-top:10px; align-items:center;">
          <span class="mini">Sterne:</span>
          <select id="oneStar">
            <option value="0">keine</option>
            <option value="1">★</option>
            <option value="2">★★</option>
            <option value="3">★★★</option>
          </select>
          <button class="primary" id="btnAddOne">Hinzufügen</button>
        </div>

        <hr style="border:none; border-top:1px solid var(--border); margin:14px 0;">

        <h2 style="margin:0 0 10px 0; font-size:16px;">Aktuelle Liste</h2>
        <p class="muted" style="margin-top:0;">
          Sterne anklicken zum Umschalten. Hier kannst du Favoriten nachträglich setzen/entfernen.
        </p>

        <div style="max-height:470px; overflow:auto; border:1px solid var(--border); border-radius:14px;">
          <table class="listTable" id="listTable">
            <thead>
              <tr><th>Vokabel</th><th>Übersetzung</th><th>Favorit</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <p class="muted" style="margin:10px 0 0 0;" id="countInfo"></p>
      </div>

    </div>
  </div>

  <!-- GAME -->
  <div class="game" id="gameScreen">
    <div class="gameTop">
      <div class="row" style="gap:10px;">
        <div class="stats" id="stats"></div>
        <div class="row" style="gap:8px; align-items:center;">
          <span class="mini">Üben:</span>
          <select id="practiceFilter">
            <option value="all">Alle</option>
            <option value="1">Nur ★</option>
            <option value="2">Nur ★★</option>
            <option value="3">Nur ★★★</option>
          </select>
        </div>
      </div>
      <div class="msg" id="msg"></div>
    </div>

    <div class="board">
      <div class="col">
        <div class="colTitle">Frage (links)</div>
        <div class="cards" id="leftCol"></div>
      </div>
      <div class="col">
        <div class="colTitle">Antwort (rechts)</div>
        <div class="cards" id="rightCol"></div>
      </div>
    </div>

    <div class="footerBar">
      <button id="btnRestart">Neuer Durchlauf</button>
      <button class="danger" id="btnStop">Zurück zur Eingabe</button>
    </div>
  </div>

</div>

<script>
/* =========================
   CONFIG
========================= */
const STORAGE_KEY = "vokabel_match_pairs_final_v1";

// Spielregeln:
const MAX_SLOTS = 8;       // 8 Karten pro Spalte
const TARGET_CORRECT = 100; // 100 richtige Matches pro Durchlauf
const POOL_SIZE = 50;      // 50 verschiedene Paare pro Durchlauf-Pool

/* =========================
   HELPERS / STORAGE
========================= */
function clampStar(x){
  const n = Number(x);
  if(!Number.isFinite(n)) return 0;
  return Math.max(0, Math.min(3, Math.round(n)));
}
function normalizeText(s){
  return String(s).replace(/\s+/g, " ").trim();
}
function starsToText(n){
  n = clampStar(n);
  return n===0 ? "" : "★".repeat(n);
}
function starsToExport(n){
  n = clampStar(n);
  return n===0 ? "" : " " + "*".repeat(n);
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function loadPairs(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr
      .filter(p => p && typeof p.left==="string" && typeof p.right==="string")
      .map(p => ({ left:p.left, right:p.right, star: clampStar(p.star) }));
  }catch{
    return [];
  }
}
function savePairs(pairs){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(pairs));
}
function toTxt(pairs){
  return pairs.map(p => `${p.left} = ${p.right}${starsToExport(p.star)}`).join("\n");
}

/* =========================
   IMPORT PARSING
========================= */
function parseStarSuffix(line){
  let t = line.trim();

  // [3] / [2] / [1]
  const mNum = t.match(/\s*\[(\d)\]\s*$/);
  if(mNum){
    const star = clampStar(mNum[1]);
    t = t.replace(/\s*\[(\d)\]\s*$/, "").trim();
    return { text: t, star };
  }

  // [***] / [**] / [*]
  const mBracketStars = t.match(/\s*\[(\*{1,3})\]\s*$/);
  if(mBracketStars){
    const star = clampStar(mBracketStars[1].length);
    t = t.replace(/\s*\[(\*{1,3})\]\s*$/, "").trim();
    return { text: t, star };
  }

  // *** plain
  const mStars = t.match(/\s(\*{1,3})\s*$/);
  if(mStars){
    const star = clampStar(mStars[1].length);
    t = t.replace(/\s(\*{1,3})\s*$/, "").trim();
    return { text: t, star };
  }

  return { text: t, star: 0 };
}

function parsePairsFromText(text){
  const lines = String(text).split(/\r?\n/);
  const out = [];
  for(const rawLine of lines){
    const line = rawLine.trim();
    if(!line) continue;

    const { text: withoutStars, star } = parseStarSuffix(line);

    const idx = withoutStars.indexOf("=");
    if(idx === -1) continue;

    const left = normalizeText(withoutStars.slice(0, idx));
    const right = normalizeText(withoutStars.slice(idx+1));
    if(!left || !right) continue;

    out.push({ left, right, star: clampStar(star) });
  }
  return out;
}

// Ganze Liste als Favorit anwenden
function applyBulkStars(list){
  const bulkStar = clampStar(document.getElementById("bulkStar")?.value ?? 0);
  const keep = !!document.getElementById("keepLineStars")?.checked;

  if(bulkStar === 0){
    return list.map(p => ({...p, star: clampStar(p.star)}));
  }
  return list.map(p => {
    const lineStar = clampStar(p.star);
    if(keep && lineStar > 0){
      return {...p, star: lineStar};
    }
    return {...p, star: bulkStar};
  });
}

/* =========================
   UI ELEMENTS
========================= */
const editorScreen = document.getElementById("editorScreen");
const gameScreen   = document.getElementById("gameScreen");

const bulkInput   = document.getElementById("bulkInput");
const importInfo  = document.getElementById("importInfo");
const countInfo   = document.getElementById("countInfo");

const previewBox   = document.getElementById("previewBox");
const previewBody  = document.getElementById("previewBody");
const previewCount = document.getElementById("previewCount");

const listTableBody = document.querySelector("#listTable tbody");

const leftCol = document.getElementById("leftCol");
const rightCol = document.getElementById("rightCol");
const stats = document.getElementById("stats");
const msg = document.getElementById("msg");
const practiceFilter = document.getElementById("practiceFilter");

let pairs = loadPairs();
let previewEntries = []; // [{left,right,star}]

function setImportInfo(text){ importInfo.textContent = text; }

function updateCounts(){
  const total = pairs.length;
  const s1 = pairs.filter(p=>p.star===1).length;
  const s2 = pairs.filter(p=>p.star===2).length;
  const s3 = pairs.filter(p=>p.star===3).length;
  countInfo.textContent = `In der App: ${total} Paare. Favoriten: ★ ${s1}, ★★ ${s2}, ★★★ ${s3}.`;
}

function renderList(){
  listTableBody.innerHTML = "";
  pairs.forEach((p, i) => {
    const tr = document.createElement("tr");

    const tdL = document.createElement("td");
    tdL.textContent = p.left;

    const tdR = document.createElement("td");
    tdR.textContent = p.right;

    const tdS = document.createElement("td");
    const starBtn = document.createElement("button");
    starBtn.className = "starsBtn";
    starBtn.textContent = (p.star===0) ? "—" : starsToText(p.star);
    starBtn.title = "Klicken: 0 → 1 → 2 → 3 → 0";
    starBtn.addEventListener("click", () => {
      pairs[i].star = (pairs[i].star + 1) % 4;
      savePairs(pairs);
      renderList();
      updateCounts();
    });
    tdS.appendChild(starBtn);

    const tdB = document.createElement("td");
    const del = document.createElement("button");
    del.className = "danger";
    del.textContent = "Löschen";
    del.addEventListener("click", () => {
      pairs.splice(i,1);
      savePairs(pairs);
      renderList();
      updateCounts();
      setImportInfo(`Gelöscht. In der App: ${pairs.length}.`);
    });
    tdB.appendChild(del);

    tr.appendChild(tdL);
    tr.appendChild(tdR);
    tr.appendChild(tdS);
    tr.appendChild(tdB);
    listTableBody.appendChild(tr);
  });
}

function renderPreview(){
  previewBody.innerHTML = "";
  previewCount.textContent = `${previewEntries.length} Zeilen`;
  previewBox.style.display = previewEntries.length ? "block" : "none";

  previewEntries.forEach((p, idx) => {
    const tr = document.createElement("tr");

    const tdL = document.createElement("td");
    tdL.textContent = p.left;

    const tdR = document.createElement("td");
    tdR.textContent = p.right;

    const tdS = document.createElement("td");
    const starBtn = document.createElement("button");
    starBtn.className = "starsBtn";
    starBtn.textContent = (p.star===0) ? "—" : starsToText(p.star);
    starBtn.title = "Klicken: 0 → 1 → 2 → 3 → 0";
    starBtn.addEventListener("click", () => {
      previewEntries[idx].star = (previewEntries[idx].star + 1) % 4;
      renderPreview();
    });
    tdS.appendChild(starBtn);

    tr.appendChild(tdL);
    tr.appendChild(tdR);
    tr.appendChild(tdS);
    previewBody.appendChild(tr);
  });
}

function setAllPreviewStars(n){
  n = clampStar(n);
  // Wenn man "alle" setzt, ist es logisch, dass nichts "geschont" wird:
  document.getElementById("bulkStar").value = String(n);
  document.getElementById("keepLineStars").checked = false;
  previewEntries = previewEntries.map(p => ({...p, star:n}));
  renderPreview();
}

/* =========================
   EDITOR EVENTS
========================= */
document.getElementById("btnAnalyze").addEventListener("click", () => {
  const parsed = parsePairsFromText(bulkInput.value);
  previewEntries = applyBulkStars(parsed);

  if(previewEntries.length === 0){
    setImportInfo("Keine gültigen Zeilen gefunden. Format: Vokabel = Übersetzung (optional: *, **, *** oder [1]/[2]/[3]).");
  }else{
    setImportInfo(`Vorschau erstellt: ${previewEntries.length} gültige Zeilen. Sterne anklicken, dann importieren.`);
  }
  renderPreview();
});

document.getElementById("setAll0").addEventListener("click", ()=>setAllPreviewStars(0));
document.getElementById("setAll1").addEventListener("click", ()=>setAllPreviewStars(1));
document.getElementById("setAll2").addEventListener("click", ()=>setAllPreviewStars(2));
document.getElementById("setAll3").addEventListener("click", ()=>setAllPreviewStars(3));

document.getElementById("btnImport").addEventListener("click", () => {
  const raw = previewEntries.length ? previewEntries : parsePairsFromText(bulkInput.value);
  const parsed = applyBulkStars(raw);

  if(parsed.length === 0){
    setImportInfo("Import abgebrochen: keine gültigen Zeilen.");
    return;
  }

  const map = new Map();
  pairs.forEach((p, idx) => map.set(`${p.left}|||${p.right}`, idx));

  let added = 0;
  let updatedStars = 0;

  for(const p of parsed){
    const key = `${p.left}|||${p.right}`;
    if(map.has(key)){
      const idx = map.get(key);
      if(
